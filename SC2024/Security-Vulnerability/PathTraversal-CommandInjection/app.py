import os
import re
from flask import Flask, request, send_file

app = Flask(__name__)

BASE_DIRECTORY = os.path.abspath("files")

# 1. 경로 조작을 통한 파일 읽기 (취약한 코드)
@app.route('/read_file', methods=['GET', 'POST'])
def read_file():
    if request.method == 'POST':
        file_path = request.form['filepath'].strip()

        # file_path 값 디버깅 출력
        print(f"file_path: {file_path}")

        # 취약한 부분 : 파일 경로 검증 없이 입력값이 사용됨
        try:
            full_path = os.path.join(BASE_DIRECTORY, file_path)
            print(f"취약한 경로 접근 시도: {full_path}")
            return send_file(full_path)
        except Exception as e:
            return f"파일을 읽는 중 오류 발생: {str(e)}"
        
    return '''
    <h1>취약한 파일 경로 읽기</h1>
    <form method="post" action="/read_file">
        파일 경로를 입력하세요 (예: example.txt, ../secret.txt): <input type="text" name="filepath"><br>
        <input type="submit" value="파일 읽기">
    </form>
    '''

if __name__ == '__main__':
    if not os.path.exists(BASE_DIRECTORY):
        os.makedirs(BASE_DIRECTORY)
    print(f"BASE_DIRECTORY: {BASE_DIRECTORY}")
    # 테스트용 파일 생성
    with open(os.path.join(BASE_DIRECTORY, 'example.txt'), 'w') as f:
        f.write("This is test file")
    
    app.run(debug=True)